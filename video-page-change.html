<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<style>
  #instructions, li {
    color: gray;
  }

  #question {
    margin: auto auto 20px auto;
    text-align: center;
  }

  #video {
    display: block;
    height: 360px;
    margin: 10px auto;
  }

  #loading-video {
    position: relative;
    top: 50%;
    text-align: center;
  }

  #answer-block {
    text-align:center;
  }

  #container {
    position: relative;
  }
</style>

<crowd-form>
  <div id="container" class="container">
    <h1>Fill in the blank based on the video</h1>

    <details id="instructions">
      <summary>Instructions (including <b>bonus</b> information)</summary>

      <br>

      <p>We need help answering ("filling") these blanks based on video information (including the audio).</p>

      <h2>Basic Instructions</h2>

      <ul>
        <li>Fill in the blank based on the video (including its audio).</li>
        <li>To "fill in the blank", write in the text field box.</li>
        <li>Write one or more <b>one-word</b> answers in the text field, <b>one per line</b>.</li>
        <li>
          When you enter numbers, please enter digital numbers instead of text
          (e.g. enter <i>"17"</i> instead of <i>"seventeen"</i>).
        </li>
      </ul>

      <h2>How To Answer</h2>

      The answers should be <b>valid</b> and <b>natural</b>.

      <ul>
        <li>E.g., saying <i>"cat"</i> when there's clearly no cat but a <i>"dog"</i> is considered <u>invalid</u>.</li>
        <li>Natural in the sense that it's something you would probably say in the situation shown in the video.
        </li>
        <li>E.g., <i>"object"</i> and <i>"entity"</i> are not something you'd <u>naturally</u> say.</li>
        <li>Use your best judgement.</li>
      </ul>

      <h2>HIT Acceptance</h2>

      Your HITs will be accepted based on how <b>accurate</b> and <b>comprehensive</b> your answers are.

      <ul>
        <li>Generally speaking, the more answers you provide, the better.</li>
        <li>But remember, every answer has to be <u>valid</u> and <u>natural</u> for the context.</li>
        <li>
          The top performer workers will be awarded a <b>bonus</b>
          (the ones that provide both the most accurate and natural answers).
        </li>
      </ul>
    </details>

    <hr>

    <div id="instance">
      <div id="video">
        <p id="loading-video">Loading video...</p>
      </div>

      <h2 id="question">Loading question...</h2>

      <div id="answer-block">
        <label style="font-size:18px;" id="answer-label" for="answers">Please view Instructions(including <b>bonus</b> information)). <br> Possible one-word answers (one per line; in order):</label>
        <br>
        <textarea id="answers" name="answers" rows="6" cols="20" required="required" autocomplete="off"
                autofocus="autofocus" placeholder="one-word answer 1&#10;one-word answer 2&#10;..."></textarea>
      </div>
    </div>
  </div>
</crowd-form>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script async src="https://www.youtube.com/iframe_api"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

<script type="text/javascript">
  let videoId = '${video_id}';
  let startTime = parseInt('${video_start_time}');
  let endTime = parseInt('${video_end_time}');
  let question = '${question}';

  // noinspection JSUnusedGlobalSymbols
  function onYouTubeIframeAPIReady() {
    let videoEnded = false;

    const player = new YT.Player('video', {
      videoId: videoId,
      playerVars: {
        autoplay: 1,
        controls: 1,
        showinfo: 0,
        modestbranding: 1,
        fs: 1,                  // full screen button
        cc_load_policy: 0,      // Hide closed captions
        iv_load_policy: 3,      // Hide the Video Annotations
        start: startTime,
        end: endTime,
        autohide: 1, // Hide video controls when playing
        rel: 0,
      },
      events: {
        // TODO: when restarting the video, it's not starting from `startTime` as it should.
        'onStateChange': state => {
          if (state.data === YT.PlayerState.ENDED) {
            videoEnded = true;
          } else if (state.data === YT.PlayerState.PLAYING && videoEnded) {
            player.seekTo(startTime,true);
            videoEnded = false;
          }
        },
      }
    });
  }

  function onDomContentLoaded() {
    const $question = document.getElementById('question');
    const $answers = document.getElementById('answers');
    $question.innerText = question;
    $answers.focus();
    $($answers).keyup(validateAnswer);

    function validateAnswer() {
      var $to_check_answers = $answers.value.split("\n");

      var $hasError1 = $answers.value.indexOf(",")!=-1;
      var $hasError2 = $answers.value.indexOf(" ")!=-1;
      var $hasError3 = $to_check_answers.indexOf("entity")!=-1;
      var $errorMsg1 = "Please start a new line for each answer";
      var $errorMsg2 = "Please input only one word for each answer.\n"+
        "Please start a new line for each answer.\n" +
        "If you have to enter a space, use '-' instead.";
      var $errorMsg3 = "Please input natural answer. (View instruction.)";

      var $hasError = $hasError1 || $hasError2 || $hasError3;

      if (typeof $answers.setCustomValidity === 'function') {
        $answers.setCustomValidity($hasError1 ? $errorMsg1 : '');
        $answers.setCustomValidity($hasError2 ? $errorMsg2 : '');
        $answers.setCustomValidity($hasError3 ? $errorMsg3 : '');
      } 
      else {
        // Not supported by the browser, fallback to manual error display...
        $($answers).toggleClass('error', !!$hasError);
        $($answers).toggleClass('ok', !$hasError);
        if ($hasError1) {
          $($answers).attr('title', $errorMsg1);
          }
        else if ($hasError2){
          $($answers).attr('title', $errorMsg2);
          }
        else if ($hasError3){
          $($answers).attr('title', $errorMsg3);
          }
        else {
          $($answers).removeAttr('title');
          }
      }
    }
  }

  function main() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
