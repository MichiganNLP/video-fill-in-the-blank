<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Task Preview like in Amazon Mechanical Turk</title>
  <style>
      iframe {
          position: fixed;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          width: 100%;
          height: 100%;
          border: none;
          margin: 0;
          padding: 0;
          overflow: hidden;
          z-index: 999999;
      }
  </style>
</head>
<body>

<iframe src="about:blank">Your browser doesn't support iframes.</iframe>

<!-- The same library AMT uses to parse CSV files. -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"
        integrity="sha512-rKFvwjvE4liWPlFnvH4ZhRDfNZ9FOpdkD/BU5gAIA3VS3vOQrQ5BjKgbO3kxebKhHdHcNUHLqxQYSoxee9UwgA=="
        crossorigin="anonymous"></script>
<script type="text/javascript">
  function fillTemplate(templatePageString, substitutions) {
    return Object.entries(substitutions).reduce((t, [k, v]) => t.replaceAll(`\${${k}}`, v), templatePageString);
  }

  function loadPageStringInIframe(pageString) {
    const doc = document.getElementsByTagName("iframe")[0].contentWindow.document;
    doc.open();
    doc.write(pageString);
    doc.close();
  }

  function getFileContent(path, onSuccess) {
    const xhr = new XMLHttpRequest();
    xhr.onreadystatechange = () => {
      if (xhr.readyState === XMLHttpRequest.DONE) {
        onSuccess(xhr.responseText);
      }
    };
    xhr.open("GET", path);
    xhr.send();
  }

  function loadAndFillTemplatePage(templatePagePath, dataPath) {
    getFileContent(templatePagePath, content => {
      Papa.parse(dataPath, {
        download: true,
        header: true,
        skipEmptyLines: true,
        error: alert,
        complete: result => loadPageStringInIframe(fillTemplate(content, result.data[0])),
      });
    });
  }

  function loadFormPage(dataPath) {
    document.body.innerHTML = `
        <h1>Task Preview like in Amazon Mechanical Turk (AMT)</h1>
        <p>Preview your AMT task web page like the workers do.</p>
        <form>
          <div>
            <label for="templatePagePath">Template page file:</label>
            <input type="file" id="templatePagePath" name="templatePagePath" required>
          </div>
          <div>
            <label for="dataPath">CSV input file (optional):</label>
            <input type="file" id="dataPath" name="dataPath" value="${dataPath}">
          </div>
          <input type="submit">
        </form>`;
  }

  function onDomContentLoaded() {
    const urlParams = new URLSearchParams(window.location.search);
    const templatePagePath = urlParams.get("templatePagePath");
    const dataPath = urlParams.get("dataPath");

    if (templatePagePath) {
      loadAndFillTemplatePage(templatePagePath, dataPath);
    } else {
      loadFormPage(dataPath);
    }
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>

</body>
</html>
