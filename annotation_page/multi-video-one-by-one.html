<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
<style>
    #instructions, li {
        color: gray;
    }

    #instructions-inner {
        margin-top: 20px;
    }

    #container {
        position: relative;
    }

    .example-answer {
        color: blue;
    }

    .counterexample-answer {
        color: red;
    }

    #collapse-instructions {
        color: grey;
    }

    .instance {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
        margin-bottom: 10px;
        padding-bottom: 10px;
        padding-left: 40px;
        padding-right: 40px;
        text-align: center;
    }

    .instance-title {
        text-align: center;
    }

    .video {
        display: block;
        height: 360px;
        margin: 10px auto;
    }

    .loading-video {
        position: relative;
        top: 50%;
        text-align: center;
    }

    .video-buttons {
        margin-bottom: 5px;
    }

    .video-button {
        border-radius: 15px;
    }

    .video-instructions {
        list-style-type: none;
    }

    .video-relates {
        position: relative;
        text-align: center;
    }

    .question-label {
        font-size: 1.5rem;
    }

    .question {
        font-size: 2rem;
        margin: auto auto 20px auto;
        text-align: center;
    }

    .answer-input {
        border: 2px solid #C2C2C2;
        box-shadow: 1px 1px 4px #EBEBEB;
        display: inline-block;
        padding: 5px;
        font-size: 2rem;
        width: 420px;
        height: 40px;
    }

    .answer-input:hover {
        border: 2px solid black;
    }

    .answer-input::placeholder {
        color: lightgray;
    }

    .answers {
        margin-bottom: 20px;
        text-align: center;
    }

    .answer {
        font-size: 1.5rem;
        margin-bottom: 5px;
        margin-right: 10px;
    }

    .remove-answer {
        margin-left: .25rem;
        color: inherit;
        font-size: 100%;
    }

    .remove-answer:hover {
        color: white;
    }

    .alert-answer {
        margin: auto;
        width: 50%;
        text-align: center;
    }

    .answer-instructions {
        list-style-type: none;
        margin-top: 10px;
        text-align: center;
    }

    #comments {
        border-radius: 15px;
        border: 4px dashed #cee3e9;
    }
</style>

<div id="container" class="container">
  <h1 id="top">Fill in the blanks according to video content</h1>

  <details id="instructions">
    <summary>Instructions (including information on <b>2 types of bonuses</b>)</summary>

    <div id="instructions-inner">
      <p>We need help answering (&quot;filling&quot;) these blanks based on video content (including the audio).</p>

      <h2>Basic Instructions</h2>

      <ul>
        <li>There are five sentences with a blank, you need to fill in <u>all</u> five blanks
          according to the content in the video (including audio).
        </li>
        <li>
          To &quot;fill in the blank&quot;, write in the text box and press Enter. Provide one or more answers.

          <ul>
            <li>
              Each answer needs to be one or more entities (a
              <a href="https://en.wikipedia.org/wiki/Noun_phrase" target="_blank">noun phrase</a>), which should contain
              <b>one or more words</b>.
            </li>
            <li>
              The answers may refer to different things, but could also (and likely will) be different ways of saying
              the same thing (as we seek diversity in the answers).
            </li>
            <li>
              Provide the answers <b>in order</b>: the first answer should be the most natural to you,
              the last answer should be the least natural to you; but all should be valid answers.
            </li>
          </ul>
        </li>
        <li>
          If the video is unavailable, just fill in <u><i>&quot;unavailable video&quot;</i></u> and
          <u><i>&quot;unavailable video 2&quot;</i></u> (because at least 2 answers are required).
        </li>
      </ul>

      <h2>How To Answer</h2>

      Each answer should be one or more <b>valid</b>, <b>natural</b>, <b>objective</b> and <b>brief</b> entities,
      and should complete the text such that the text becomes a good description of the video.

      <ul>
        <li>
          Each answer should contain one or more words.
        </li>
        <li>
          It should be valid, in the sense that it should be an appropriate answer for what is represented in the
          video.

          <ul>
            <li>E.g., saying <i>&quot;<span class="counterexample-answer">cat</span>&quot;</i> when there's clearly no
              cat but a <i>dog</i> in the video, is considered <u>invalid</u>.
            </li>
          </ul>
        </li>
        <li>
          It should be natural, in the sense that it should be something you would normally say in the situation shown
          in the video.

          <ul>
            <li>
              E.g., <i>&quot;<span class="counterexample-answer">object</span>&quot;</i> and <i>&quot;<span
                class="counterexample-answer">entity</span>&quot;</i> <u>aren't</u> something you'd naturally say.
            </li>
          </ul>
        </li>
        <li>
          They should be <u>in order</u>. The first answer should be the one that naturally comes to your mind first,
          and the following ones should feel less and less natural to you.
        </li>
        <li>
          Respond matter-of-factly (as objectively as possible). Stick to what you can see or hear from the video.

          <ul>
            <li>E.g., <i>&quot;<span class="counterexample-answer">beautiful</span>&quot;</i> is likely <u>not</u> a
              good word to use within an answer.
            </li>
          </ul>
        </li>
        <li>
          Don't use descriptors unless necessary.

          <ul>
            <li>
              <i>&quot;<span class="counterexample-answer">yellow ball</span>&quot;</i> ->
              <i>&quot;<span class="example-answer">ball</span>&quot;</i>
            </li>
            <li>
              <i>&quot;<span class="counterexample-answer">cute dog</span>&quot;</i> ->
              <i>&quot;<span class="example-answer">dog</span>&quot;</i></li>
          </ul>
        </li>
        <li>
          When you enter numbers, please enter digits instead of text.

          <ul>
            <li><i>&quot;<span class="counterexample-answer">Seventeen</span>&quot;</i> ->
              <i>&quot;<span class="example-answer">17</span>&quot;</i></li>
          </ul>
        </li>
        <li>Try not to use the title or the description from the video to fill in the blank.</li>
        <li>Use your best judgment.</li>
      </ul>

      <h2>HIT Acceptance</h2>

      Your HITs will be accepted based on how <b>accurate</b> and <b>comprehensive</b> your answers are.

      <ul>
        <li>Generally speaking, the more answers you provide, the better.</li>
        <li>
          But remember, every answer has to be <u>valid</u>, <u>natural</u>, <u>objective</u>, and <u>brief</u> for
          the given context.
        </li>
      </ul>

      <h2>Bonuses</h2>

      <ul>
        <li>
          There are 2 types of bonuses:

          <ol>
            <li>
              You will receive a 1st type of bonus for each correct answer, with the following rules. We will evaluate
              each answer, and compute the number of correct answers (the ones that comply with the above rules).

              For every HIT, 10 correct answers are considered to be covered by the regular HIT pay (2 for each
              of the 5 blanks per HIT). For every extra correct answer you will receive this bonus, for up to 3 answers
              per blank. In other words, if you have 5 correct answers per blank, you will receive the maximum amount
              for this type of bonus (3 extra correct answers * 5 blanks = 15x the bonus value).

              The value of the bonus for each correct answer is the HIT pay amount divided by 10 (2 * 5 blanks per HIT).
              You could get up to 15 times this value for every HIT.

              With this, we want to encourage people to answer as many different answers they can come up with,
              up to a reasonable amount. Don't worry if you can't come up with 5, because if you spend a lot of time
              in a blank then it's probably not worth it.

              Remember the answers have to be correct, otherwise not only you risk not getting the bonus but also
              getting your HITs rejected.
            </li>
            <li>
              For each HIT, the worker with the largest amount of correct answers will receive a 2nd type of bonus.
              This bonus value is the same as the HIT pay amount.

              We want to encourage workers to answer as many as they can.
            </li>
          </ol>
        </li>
        <li>
          With these 2 types of bonus, we encourage the following way of answering. Go to every blank, watch the
          video, read the text with the blank, and try to answer the blank with as many different answers you can
          come up to, even beyond 5 (because you could get the 2nd type of bonus). If many seconds pass and you can't
          come up with more answers, then just move on to the next blank because it's probably not worth it
          to spend a lot of time in each blank.
        </li>
      </ul>

      <div id="example"></div>

      <button type="button" class="btn" id="collapse-instructions" onclick="collapseInstructions()">
        &#x25B2 Collapse instructions
      </button>
    </div>
  </details>

  <hr>

  <crowd-form onsubmit="return checkValid()">
    <div id="instances"></div>

    <div class="form-group">
      <label for="comments">Comments:</label>
      <textarea class="form-control" id="comments" name="comments" rows="10"
                placeholder="Please, write any comment/error/suggestion you have."></textarea>
    </div>

    <crowd-button id="submit-button" form-action="submit" variant="primary">Submit</crowd-button>
  </crowd-form>
</div>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
<!--suppress CommaExpressionJS -->
<script type="text/javascript">
  // JS string interpolations clash with the Amazon Mechanical Turk template system, as they both use the syntax ${...}.
  // So we do a trick which is to put the simple string interpolation of variables inside a comma operator expression,
  // which always returns the last operand. For example, if we have to interpolate the variable "i" inside the backticks
  // (`) then we do `${(0, i)}`. This is basically the minimum we can write. The parentheses are actually optional, but
  // WebStorm complains otherwise. Note we put "0" but it could be any other expression.
  // Complex expressions usually don't need this. I tried other variants, but it seems that AMT captures spaces and plus
  // signs as valid syntax. The ternary operator is another option (`${1 ? i : 0}`), though more verbose.

  const ENTER_KEY_CODE = 13;

  const videoIds = ["k7aPk5JcT-Q", "${video1_id}", "${video2_id}", "${video3_id}", "${video4_id}", "${video5_id}"]
      .map(v => {
        if (templateWasNotSubstituted(v)) {
          return "k7aPk5JcT-Q";
        } else {
          return v;
        }
      });
  const questions = ["The person drinks [MASK] at the bar.", "${question1}", "${question2}", "${question3}",
    "${question4}", "${question5}"]
      .map((q, i) => {
        if (templateWasNotSubstituted(q)) {
          return "This is the preview of [MASK] " + i + ".";
        } else {
          return q;
        }
      })
      .map(q => {
        const maskPosition = q.indexOf("[MASK]");
        console.assert(maskPosition !== -1 && maskPosition === q.lastIndexOf("[MASK]"))
        return q;
      })
      .map(escapeHtml)
      .map((q, i) => q.replace("[MASK]",
          `<input type="text" class="form-control answer-input" id="answer-input-${(0, i)}"
                  name="answer-input-${(0, i)}"
                  placeholder="type an answer and hit Enter" ${i === 0 ? "disabled" : ""}>`));
  const startTimes = ["0", "${video1_start_time}", "${video2_start_time}", "${video3_start_time}",
    "${video4_start_time}", "${video5_start_time}"]
      .map(q => {
        if (templateWasNotSubstituted(q)) {
          return "0";
        } else {
          return q;
        }
      }).map(parseFloat).map(Math.round);
  const endTimes = ["10", "${video1_end_time}", "${video2_end_time}", "${video3_end_time}",
    "${video4_end_time}", "${video5_end_time}"]
      .map(q => {
        if (templateWasNotSubstituted(q)) {
          return "10";
        } else {
          return q;
        }
      }).map(parseFloat).map(Math.round);

  console.assert(videoIds.length === questions.length && videoIds.length === startTimes.length
      && videoIds.length === endTimes.length);
  console.assert(endTimes.every((endTime, i) => endTime >= startTimes[i]));
  console.assert(questions.every(q => q))

  const exampleAnswers = ["beer", "a glass of beer", "the beverage", "a pint of beer", "alcohol", "booze"];

  const speeds = [0.25, 0.5, 1, 1.5, 2];
  const videoSpeedIndices = Array(videoIds.length).fill(speeds.findIndex(x => x === 1));
  let players = [];

  function templateWasNotSubstituted(s) {
    return s.startsWith("${") && s.endsWith("}");
  }

  // From https://stackoverflow.com/a/6234804/1165181
  function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        // Use single quotes as AMT expands the double quote escaping and gives a syntax error otherwise:
        .replace(/"/g, '&quot;')
        .replace(/'/g, "&#039;");
  }

  function createInstanceElement(i, isExample, title, duration, question, showNextButton) {
    return $(`
        <div class="instance" id="instance-${(0, i)}">
          <h2 class="instance-title">${(0, title)}</h2>
          <div class="video" id="video-${(0, i)}">
            <p class="loading-video">Loading video…</p>
          </div>
          <div class="video-relates">
            <div class="btn-group video-buttons" role="group" aria-label="Video controls">
              <button type="button" class="btn btn-dark video-button" id="rewind-${(0, i)}" data-toggle="tooltip"
                      data-placement="bottom" title="Go back">-5s</button>
              <button type="button" class="btn btn-dark video-button" id="slow-down-${(0, i)}" data-toggle="tooltip"
                      data-placement="bottom" title="Decrease speed">Speed&#8595</button>
              <button type="button" class="btn btn-dark video-button" id="restart-video-${(0, i)}" data-toggle="tooltip"
                      data-placement="bottom" title="Replay">&#8634</button>
              <button type="button" class="btn btn-dark video-button" id="speed-up-${(0, i)}" data-toggle="tooltip"
                      data-placement="bottom" title="Increase speed">Speed&#8593</button>
              <button type="button" class="btn btn-dark video-button" id="forward-${(0, i)}" data-toggle="tooltip"
                      data-placement="bottom" title="Go forward">+5s</button>
            </div>
            <ul class="video-instructions">
              <li>
                Please watch this <i>${(0, duration)}-second</i> video while you listen to its <b><u>audio</u></b> (you
                may need to adjust your <b>device volume</b>).
              </li>
              <li>
                When the video ends, <b>do not</b> click on any other video. Click the <u>buttons above</u> to control
                the video.
              </li>
              <li>Please, <b>do not</b> consider the YouTube title information when filling the blank.</li>
            </ul>
          </div>

          <hr>

          <div class="form-group">
            <label class="question-label" for="answer-input-${(0, i)}">Fill in the blank:</label>
            <p class="question" id="question-${(0, i)}">${(0, question)}</p>
          </div>

          <div class="answers" id="answers-${(0, i)}"><p>Your answers:</p></div>

          <div class="alert alert-warning alert-answer" id="alert-${(0, i)}"></div>

          <ul class="answer-instructions">
            <li>
              Each provided answer needs to be <i><u><b>one or more entities</b></u></i>, which should contain
              one or more words;
            </li>
            <li>
              Please review the <a href="#instructions">instructions</a> (includes information about the <b>bonus</b>);
            </li>
            <li>Fill in <b>valid</b>, <b>natural</b>, <b>objective</b> and <b>brief</b>;</li>
            <li>You need to fill in at least 2 answers;</li>
            <li>The more you fill in, the higher chances you can get the <b>bonus</b>;</li>
            <li>Try not to use the title or the description from the video to fill in the blank;</li>
            <li>Fill in the boxes <b>in order</b> from the most natural to the least natural answer.</li>
          </ul>

          ${showNextButton ? `<button type="button" class="btn btn-info" id="next-instance-${(0, i)}">
                                Go to the next Blank (or press 'Ctrl + Enter' from the text input)
                              </button>` : ""}
        </div>`);
  }

  function createInstances() {
    questions.forEach((question, i) => {
      const isExample = i === 0;
      const title = isExample ? "Example" : `Blank ${(0, i)}`;
      const duration = endTimes[i] - startTimes[i];
      const parentId = isExample ? "example" : "instances";
      const showNextButton = !isExample && i < questions.length - 1;
      createInstanceElement(i, isExample, title, duration, question, showNextButton).appendTo(`#${(0, parentId)}`);
      if (showNextButton) {
        $(`#next-instance-${(0, i)}`).click(() => {
          window.location.href = `#instance-${(0, i + 1)}`;
          $(`#answer-input-${(0, i + 1)}`).focus();
        });
      }
    });
  }

  // noinspection JSUnusedGlobalSymbols
  function onYouTubeIframeAPIReady() {
    // noinspection JSUnresolvedFunction,JSUnresolvedVariable,SpellCheckingInspection
    players = videoIds.map((videoId, i) => new YT.Player(`video-${(0, i)}`, {
      videoId: videoId,
      playerVars: {
        enablejsapi: 1,
        loop: 1,
        autoplay: 0,
        controls: 0,            // hide the controls
        disablekb: 1,           // not respond to keyboard controls
        modestbranding: 1,
        fs: 0,                  // full screen button
        cc_load_policy: 0,      // Hide closed captions
        iv_load_policy: 3,      // Hide the Video Annotations
        start: startTimes[i],
        end: endTimes[i],
      }
    }));
  }

  function setUpVideoButtons() {
    videoIds.forEach((_, i) => {
      $(".video-button").mouseup(e => $(e.target).blur());

      $(`#restart-video-${(0, i)}`).click(() => {
        // noinspection JSUnresolvedFunction
        players[i].seekTo(startTimes[i], true);
        // noinspection JSUnresolvedFunction
        players[i].playVideo();
      });

      // noinspection JSUnresolvedFunction
      $(`#forward-${(0, i)}`)
          .click(() => players[i].seekTo(Math.min(Math.max(endTimes[i] - 1, startTimes[i]),
              players[i].getCurrentTime() + 5), true));

      // noinspection JSUnresolvedFunction
      $(`#rewind-${(0, i)}`)
          .click(() => players[i].seekTo(Math.max(players[i].getCurrentTime() - 5, startTimes[i]), true));

      $(`#speed-up-${(0, i)}`).click(() => {
        if (videoSpeedIndices[i] < speeds.length - 1) {
          videoSpeedIndices[i]++;
          // noinspection JSUnresolvedFunction
          players[i].setPlaybackRate(speeds[videoSpeedIndices[i]]);
        }
      });

      $(`#slow-down-${(0, i)}`).click(() => {
        if (videoSpeedIndices[i] > 0) {
          videoSpeedIndices[i]--;
          // noinspection JSUnresolvedFunction
          players[i].setPlaybackRate(speeds[videoSpeedIndices[i]]);
        }
      });
    });
  }

  function setUpVideos() {
    setUpVideoButtons();
  }

  function collapseInstructions() {
    $("#instructions").removeAttr("open");
    window.location = "#top";
  }

  function countAnswers(i) {
    return $(`#instance-${(0, i)} .answer`).length;
  }

  function questionCompleted(i) {
    return countAnswers(i) >= 2;
  }

  function checkValid() {
    const completed = questions.map((_, i) => {
      const completed = questionCompleted(i);
      const message = completed ? "" : "Fill in at least 2 answers.";
      document.getElementById(`answer-input-${(0, i)}`).setCustomValidity(message);
      return completed;
    }).every(Boolean);

    document.getElementsByTagName("form")[0].reportValidity();

    return completed;
  }

  function checkValidationAlerts(i) {
    const $errorMessage = $(`#alert-${(0, i)}`);
    if (questionCompleted(i)) {
      $errorMessage.fadeOut("fast");
    } else {
      $errorMessage.text("Please fill in at least 2 answers.").fadeIn();
    }
  }

  function removeAnswer($button) {
    const $answer = $button.parentNode;
    const $inputAnswers = $answer.parentNode;
    $inputAnswers.removeChild($answer);

    const inputAnswersId = $inputAnswers.getAttribute("id");
    const i = parseInt(inputAnswersId.substring(inputAnswersId.lastIndexOf("-") + 1));

    checkValidationAlerts(i);
  }

  function createAnswerElement(i, answerIndex, answer, isEnabled) {
    return $(`
        <span class="badge badge-dark answer">
          ${(0, answer)}
          <button type="button" class="close remove-answer" aria-label="Close" onclick="removeAnswer(this)"
                  ${isEnabled ? "" : "disabled"}>
            <span aria-hidden="true">&times;</span>
          </button>
          <input type="hidden" name="answer-${(0, i)}-${(0, answerIndex)}" value="${answer.replaceAll('"', '\\"')}">
        </span>`);
  }

  function normalizeAnswerToLookForRepetitions(answer) {
    return $.trim(
        answer
            .toLowerCase()
            .replace(/[!"#$%&'()*+,\-./:;<=>?@\[\\\]^_`{|}~]/g, "")  // Same as in Python's `string.punctuation`.
            .replace(/\b(?:an?|the)\b/g, "")
    );
  }

  function isAnswerValid(i, answer) {
    answer = normalizeAnswerToLookForRepetitions(answer);
    if (!answer) {
      return false;
    }
    const answers = new Set(
        $(`#answers-${(0, i)} input`)
            .toArray()
            .map($e => $e.value)
            .map(normalizeAnswerToLookForRepetitions)
    );
    return !answers.has(answer);
  }

  function showInputValidity($input, isValid) {
    if (isValid) {
      $input.get(0).setCustomValidity("");
      $input.removeClass("is-invalid");
    } else {
      $input.get(0).setCustomValidity("The answer is either empty or already provided.");
      document.getElementsByTagName("form")[0].reportValidity();
      // Don't use the pseudo-classes :valid and :invalid through the form class .was-validated as it'd also show the
      $input.addClass("is-invalid");
    }
  }

  function addAnswer($input, i) {
    const answer = $.trim($input.val());
    if (isAnswerValid(i, answer)) {
      const answerCount = countAnswers(i);
      const isExample = i === 0;
      const isEnabled = !isExample;
      createAnswerElement(i, answerCount + 1, answer, isEnabled).appendTo(`#answers-${(0, i)}`);
      $input.val("");
      checkValidationAlerts(i);
      showInputValidity($input, true);  // In case it's entering an answer after having pressed Submit.
    } else {
      showInputValidity($input, false);
    }
  }

  function setUpInputListeners() {
    questions.forEach((_, i) => {
      $(`#answer-input-${(0, i)}`)
          .keydown(e => {
            if (e.keyCode === ENTER_KEY_CODE) {
              e.preventDefault();
              if (e.ctrlKey) {
                const $nextBlank = $(`#next-instance-${(0, i)}`);
                if ($nextBlank.length) {
                  $nextBlank.click();
                }
              } else {
                addAnswer($(e.target), i);
              }
            } else {
              showInputValidity($(e.target), true);
            }
          });
      checkValidationAlerts(i);
    });
  }

  function addExampleAnswers() {
    const $exampleAnswerInput = $("#answer-input-0");
    exampleAnswers.forEach(answer => {
      $exampleAnswerInput.val(answer);
      addAnswer($exampleAnswerInput, 0);
    });
  }

  function onDomContentLoaded() {
    createInstances();
    setUpVideos();
    setUpInputListeners();
    addExampleAnswers();
  }

  function main() {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>
<script src="https://www.youtube.com/iframe_api" async></script>
