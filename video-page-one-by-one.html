<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
  integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
  #instructions,
  li {
    color: gray;
  }

  #question {
    margin: auto auto 20px auto;
    text-align: center;
  }

  #video {
    display: block;
    height: 360px;
    margin: 10px auto;
  }

  #loading-video {
    position: relative;
    top: 50%;
    text-align: center;
  }

  #video-relates {
    position: relative;
    text-align: center;
  }

  #answer-label-div {
    text-align: center;
  }

  #answer-block {
    margin: auto;
    width: 80%;
    text-align: center;
  }

  #add-answer {
    border-radius: 15px;
    background-color: rgba(117, 122, 118, 0.822);
    /* Green */
    border: none;
    color: white;
    padding: 8px 25px;
    text-align: center;
    font-size: 16px;
  }
  
  #restart-video {
    border-radius: 15px;
    background-color: rgba(117, 122, 118, 0.822);
    /* Green */
    border: none;
    color: white;
    padding: 9px 20px;
    text-align: center;
    font-size: 17px;
  }

  input {
    border: 1px solid #C2C2C2;
    box-shadow: 1px 1px 4px #EBEBEB;
    border-radius: 4px;
    padding: 5px;
    margin-left: 1px;
    margin-bottom: 2px;
  }

  /* input[type=text]{
    width: 10px;
  } */


  #container {
    position: relative;
  }

  #error-message {
    margin: auto;
    width: 50%;
    display: none;
    text-align: center;
  }
</style>

<crowd-form>
  <div id="container" class="container">
    <h1>Fill in the blank based on the video and its audio</h1>

    <details id="instructions">
      <summary>Instructions (including <b>bonus</b> information)</summary>

      <br>

      <p>We need help answering ("filling") these blanks based on video information (including the audio).</p>

      <h2>Basic Instructions</h2>

      <ul>
        <li>Fill in the blank for the text below, based on the video (including its audio).</li>
        <li>
          To "fill in the blank", write in the text boxes. Write one or more answers in the boxes,
          <b>one per box</b>.
        </li>
        <li>
          When you enter numbers, please enter digital numbers instead of text
          (e.g., enter <i>"17"</i> instead of <i>"seventeen"</i>).
        </li>
        <li>If the video is unavailable, just fill in <u><i>"unavailable video"</i></u>.</li>
      </ul>

      <h2>How To Answer</h2>

      The answers should be <b>valid</b>, <b>natural</b> and <b>concise</b>, 
      and should complete the text such that the text becomes a good description of the video. 

      <ul>
        <li>It should be valid, in the sense that it should be an appropriate answer for what is represented in the video.</li>
        <ul>
          <li>E.g., saying <i>"cat"</i> when there's clearly no cat but a <i>"dog"</i> is considered <u>invalid</u>.</li>
        </ul>
        <li>It should be natural, in the sense that it should be something you would normally say in the situation shown in the video.</li>
        <ul>
          <li>E.g., <i>"object"</i> and <i>"entity"</i> are not something you'd <u>naturally</u> say.</li>
        </ul>
        <li>Unless necessary, try not to fill in descriptors.</li>
        <ul>
          <li>E.g., state <i>"ball"</i> instead of <i>"yellow ball"</i>; or <i>"dog"</i> instead of <i>"cute dog"</i>.</li>
        </ul>
        <li>Use your best judgment.</li>
      </ul>

      <h2>HIT Acceptance</h2>

      Your HITs will be accepted based on how <b>accurate</b> and <b>comprehensive</b> your answers are.

      <ul>
        <li>Generally speaking, the more answers you provide, the better.</li>
        <li>But remember, every answer has to be <u>valid</u> and <u>natural</u> for the context.</li>
        <li>
          The top performer workers, who provide answers that are correct, will be awarded a <b>bonus</b>.
        </li>
      </ul>
    </details>

    <hr>

    <div id="instance">
      <div id="video">
        <p id="loading-video">Loading video...</p>
      </div>
      <div id="video-relates">
        <label id="video-instruction" style="font-size:18px;">
          Please watch this <i>-- second</i> video while you listen to its <b><u>audio</u></b> (You may need to adjust your <b>device volume</b>).
          <br>When the video ends, <b>do not</b> click on any other video. Press <b>Restart Video</b> if you need to re-watch it.
        </label>
        <br>
        <button id="restart-video" type="button">Restart Video</button>
      </div>
      <hr>

      <h2 id="question">Loading question...</h2>
      <div class="alert alert-info" id="error-message"></div>

      <div id="answer-label-div">
        <label style="font-size:18px;" for="answers" id="answer-label">
          Each provided answer needs to be <big><i><u><b>--</b></u></i></big>.
          <br>Please review the <a href="#instructions">Instructions</a> (includes information about the <b>bonus</b>);
          <br>Fill in <b>valid</b>, <b>natural</b> and <b>concise</b> answers  (please fill in as many answers as possible, while still being valid, natural and concise);
          <br>Write one answer per text box. Press <b>Add another answer</b> to add a new answer box.</label>
      </div>

      <div id="answer-block">
        <input type="text" id="answer1" name="answer1" minlength="1"'
                ' maxlength="20" size="20" placeholder="answer 1" autocomplete="off"></input>
        <button id="add-answer" type="button">Add another answer</button>
    </div>
  </div>
</crowd-form>

<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
  integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
  integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<script type="text/javascript">
  let videoId = '${video_id}';
  let postag = '${pos_tag}';
  let question = '${question}';
  let startTime = Math.floor(parseFloat('${video_start_time}'));
  let endTime = Math.ceil(parseFloat('${video_end_time}'));
  videoId = videoId.substring(2);
  question = question.replace("[MASK]","<a href=\"#answer1\" style=\"color:#B2BABB;\">_____</a>");
  var poswarn = "an adjective";
  if(postag == "NN"){
    poswarn = "a noun";
  }

  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  // noinspection JSUnusedGlobalSymbols
  function onYouTubeIframeAPIReady() {
    player = new YT.Player('video', {
      videoId: videoId,
      playerVars: {
        enablejsapi: 1,
        loop: 1,
        autoplay: 1,
        controls: 0,            // hide the controls
        disablekb: 1,           // not respond to keyboard controls
        modestbranding: 1,
        fs: 0,                  // full screen button
        cc_load_policy: 0,      // Hide closed captions
        iv_load_policy: 3,      // Hide the Video Annotations
        start: startTime,
        end: endTime,
      },
      events: {
        // 'onStateChange': onPlayerStateChange
      }
    });
  }
  var videoEnded = false;
  function onPlayerStateChange(event) {
    console.log(event);
    if (event.data == YT.PlayerState.ENDED) {
      videoEnded = true;
    } else if (event.data == YT.PlayerState.PLAYING && videoEnded) {
      event.target.seekTo(startTime, true);
      videoEnded = false;
    }
  }

  $("#restart-video").click(function () {
    player.seekTo(startTime, true);
	player.playVideo();
  });

  // player.getCurrentTime()

  function onDomContentLoaded() {
    const $video_instruction = document.getElementById("video-instruction").innerHTML;
    const $answer_label = document.getElementById("answer-label").innerHTML;
    const $question = document.getElementById('question');
    const $answer1 = document.getElementById('answer1');
    const $errormessage = document.getElementById('error-message');
    // show video length
    document.getElementById("video-instruction").innerHTML = $video_instruction.replace("--",(endTime-startTime).toString());
    // show POS-tag
    document.getElementById("answer-label").innerHTML = $answer_label.replace("--",poswarn);

    $question.innerHTML = question;
    $answer1.focus();
    $($errormessage).text("Please fill in with at least one answer").fadeIn();

    // add answer box
    let $NoAnswer = 2;
    $("#add-answer").click(function () {
      if ($NoAnswer <= 12) {
        let $ansid = "answer" + $NoAnswer.toString();
        let $ansname = "answer " + $NoAnswer.toString();
        $('input[type="text"]').last().after("<input type=\"text\" id=\"" + $ansid + "\" name=\"" + $ansname + "\" minlength=\"1\"" +
          "maxlength=\"20\" size=\"20\" placeholder=\"" + $ansname + "\" autocomplete=\"off\"></input>");
        document.getElementById($ansid).addEventListener('keyup', event => {    // see function below
          AtLeastOneFilled();
        });
        $NoAnswer++;
      }
      else {
        $($errormessage).text("at most 12 answers").fadeIn();
      }
    });

    // at least one input should be filled
    document.querySelectorAll('input').forEach(item => {
      item.addEventListener('keyup', event => {
        AtLeastOneFilled();
      })
    })

    function AtLeastOneFilled() {
      var empty = true;
      $('input[type="text"]').each(function () {
        if ($(this).val() != "") {
          empty = false;
        }
      });
      if (empty) {
        $($errormessage).text("Please fill in with at least one answer").fadeIn();
      }
      else {
        $($errormessage).fadeOut("fast");
      }
    }

    // validate whether the answer is nature and valid
    function validateAnswer() {
      var $to_check_answers = $answers.value.split("\n");

      var $errorMsg1 = "Please start a new line for each answer";
      var $errorMsg2 = "Please input only one word for each answer.\n" +
        "Please start a new line for each answer.\n" +
        "If you have to enter a space, use '-' instead.";
      var $errorMsg3 = "Please input natural answer. (View instruction.)";

      if ($answers.value.indexOf(",") != -1) {
        $($errormessage).text($errorMsg1).fadeIn();
      }
      else if ($answers.value.indexOf(" ") != -1) {
        $($errormessage).text($errorMsg2).fadeIn();
      }
      else if ($to_check_answers.indexOf("entity") != -1) {
        $($errormessage).text($errorMsg3).fadeIn();
      }
      else {
        $($errormessage).fadeOut("fast");
      }
    }
  }

  function main() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', onDomContentLoaded);
    } else {
      onDomContentLoaded();
    }
  }

  main();
</script>